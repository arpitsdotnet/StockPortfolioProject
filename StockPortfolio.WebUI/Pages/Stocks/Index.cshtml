@page
@model StockPortfolio.WebUI.Pages.Stocks.IndexModel
@{
    ViewData["Title"] = "Stock Securities";
}


<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"> Stock Securities</h5>
            <a asp-page="." asp-route-handler="OpenAdd" class="btn btn-sm btn-primary">Add Security</a>
        </div>

        @if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                @Model.ErrorMessage
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }
        <div class="card-body p-0">
            <div class="row p-3">
                <div class="col-md-4">
                    <input type="text"
                           id="stockSearch"
                           class="form-control"
                           placeholder="Search by Symbol or Name..." />
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Symbol</th>
                        <th>Name</th>
                        <th class="text-end">Price</th>
                        <th class="text-end">Change</th>
                        <th class="text-end">% Change</th>
                    </tr>
                </thead>
                <tbody>
                    @if (!Model.Securities.Any())
                    {
                        <tr>
                            <td colspan="5" class="text-center py-3">
                                No securities available
                            </td>
                        </tr>
                    }
                    else
                    {
                        foreach (var stock in Model.Securities)
                        {
                            @* var css = stock.Change >= 0 ? "text-success" : "text-danger";

                            <tr>
                                <td>@stock.Symbol</td>
                                <td>@stock.Name</td>
                                <td class="text-end">@stock.LastPrice.ToString("N2")</td>
                                <td class="text-end @css">
                                    @stock.Change.ToString("N2")
                                </td>
                                <td class="text-end @css">
                                    @stock.ChangePercent.ToString("N2")%
                                </td>
                            </tr> *@
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@if (Model.ShowModal || Model.SearchResults.Any() || !ViewData.ModelState.IsValid)
{
    <div class="modal show d-block" tabindex="-1" role="dialog" aria-modal="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Security</h5>
                    <a asp-page="." class="btn-close"></a>
                </div>
                <div class="modal-body">
                    <form method="post" asp-page-handler="Search">
                        <div class="mb-3">
                            <label for="SearchKeywords" class="form-label">Search by symbol or name</label>
                            <div class="input-group">
                                <input asp-for="SearchKeywords" class="form-control" placeholder="e.g. AAPL" />
                                <button type="submit" class="btn btn-outline-secondary">Search</button>
                            </div>
                        </div>
                    </form>

                    @if (!ViewData.ModelState.IsValid)
                    {
                        <div class="alert alert-danger">
                            @foreach (var err in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                            {
                                <div>@err.ErrorMessage</div>
                            }
                        </div>
                    }

                    @if (Model.SearchResults.Any())
                    {
                        <form method="post" asp-page-handler="Create">
                            <div class="mb-3">
                                <label class="form-label">Search Results</label>
                                <select asp-for="SelectedSymbol" class="form-select" onchange="(function(){ var idx=this.selectedIndex; var opt=this.options[idx]; var data = opt.value ? JSON.parse(opt.value) : null; if(data){ document.getElementById('SelectedName').value=data.Name || data.name || ''; document.getElementById('SelectedExchange').value=data.Exchange||data.exchange||''; document.getElementById('SelectedType').value=data.Type||data.type||''; document.getElementById('SelectedCurrency').value=data.Currency||data.currency||''; }})()">
                                    <option value="">-- select a security --</option>
                                    @for (int i = 0; i < Model.SearchResults.Count; i++)
                                    {
                                        var item = Model.SearchResults[i];
                                        var json = System.Text.Json.JsonSerializer.Serialize(new { Symbol = item.Symbol, Name = item.Name, Exchange = item.Exchange, Currency = item.Currency });
                                        <option value="@json">@item.Symbol - @item.Name</option>
                                    }
                                </select>
                            </div>

                            <input type="hidden" asp-for="SelectedName" id="SelectedName" />
                            <input type="hidden" asp-for="SelectedExchange" id="SelectedExchange" />
                            <input type="hidden" asp-for="SelectedType" id="SelectedType" />
                            <input type="hidden" asp-for="SelectedCurrency" id="SelectedCurrency" />

                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary" @(string.IsNullOrWhiteSpace(Model.SelectedSymbol) ? "disabled" : "")>Save</button>
                            </div>
                        </form>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="modal-backdrop show"></div>
}